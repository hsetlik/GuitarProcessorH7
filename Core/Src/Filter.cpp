/*
 * Filter.cpp
 *
 *  Created on: Feb 4, 2025
 *      Author: hayden
 */

#include "Filter.h"

void ConvDirectFIR::init(const float* kernel){
	// grip the time-reversed kernel
	for(uint16_t idx = 0; idx < CD_KERNEL_LENGTH; idx++){
		kernelTimeReversed[CD_KERNEL_LENGTH - (idx + 1)] = kernel[idx];
	}
	// call the CMSIS init function
	arm_fir_init_f32(&firProc, CD_KERNEL_LENGTH, kernelTimeReversed, firBuf, CD_BLOCK_LENGTH);
}

void ConvDirectFIR::processChunk(float* input, float* output, uint16_t length){
	arm_fir_f32(&firProc, input, output, length);
}
/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 43402 Hz

Kernel length = 173

* 0 Hz - 500 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 4.097467313186343 dB

* 750 Hz - 900 Hz
  gain = 1.3
  desired ripple = 5 dB
  actual ripple = 4.0974673131863435 dB

* 1000 Hz - 2300 Hz
  gain = 0
  desired attenuation = -12 dB
  actual attenuation = -12.158742075755866 dB

* 2500 Hz - 21701 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -40.15874207575587 dB

*/


const float CD_Kernel[CD_KERNEL_LENGTH] ={
		  -0.0071208527855767855,
		  -0.005162958310249838,
		  -0.006708082220353774,
		  -0.008276883743951472,
		  -0.009771145249317444,
		  -0.011086164938723301,
		  -0.012117629011990618,
		  -0.01276879757012133,
		  -0.012960285908648433,
		  -0.012636822452147345,
		  -0.011773343623041868,
		  -0.010378613194328402,
		  -0.008494358476285286,
		  -0.006195963524169574,
		  -0.0035863761076325895,
		  -0.0007899639812546934,
		  0.0020592583561588242,
		  0.004823725659403927,
		  0.007374378209144512,
		  0.00959897179474267,
		  0.011414470022895255,
		  0.012767760394852088,
		  0.013638237562541927,
		  0.014043595517422841,
		  0.01403289456850413,
		  0.013676694282834221,
		  0.013067123635644093,
		  0.012306402673405385,
		  0.011487336422989965,
		  0.01070229545115118,
		  0.010014740164925935,
		  0.009469742018526527,
		  0.009081040701586014,
		  0.008835447947138357,
		  0.008693176253432402,
		  0.00859550617341363,
		  0.008469852998115944,
		  0.00823880431591013,
		  0.007829512594212608,
		  0.007181642699552285,
		  0.006254535098650449,
		  0.005030780924734345,
		  0.003521356088745773,
		  0.001762473344266541,
		  -0.00018472467841555655,
		  -0.0022437206001892037,
		  -0.004321366216966219,
		  -0.006326046233047093,
		  -0.008166925139389873,
		  -0.009764459025167357,
		  -0.011058072804551034,
		  -0.012005605649957916,
		  -0.01258688756227853,
		  -0.012805102027720998,
		  -0.012679715855043539,
		  -0.012243449095484303,
		  -0.011540764119581194,
		  -0.010615025071490678,
		  -0.009507894412126666,
		  -0.008251693365657897,
		  -0.006868343925364158,
		  -0.005364534932887156,
		  -0.0037350392557077795,
		  -0.001964019021497103,
		  -0.00002965122492762741,
		  0.0020927206184564147,
		  0.004424510860278145,
		  0.006978638220769068,
		  0.009757259216953088,
		  0.012747454980735425,
		  0.015921952170558078,
		  0.019232913695483172,
		  0.022633048320115097,
		  0.026037240524905556,
		  0.02939955656305224,
		  0.03263138429596518,
		  0.03567261111002296,
		  0.03847765220632961,
		  0.04099849429051236,
		  0.043202696044098106,
		  0.045081156540342844,
		  0.04663594046483888,
		  0.04787442524377228,
		  0.04881068060704714,
		  0.04946229159153692,
		  0.04984655950545277,
		  0.04997338189316423,
		  0.04984655950545277,
		  0.04946229159153692,
		  0.04881068060704714,
		  0.04787442524377228,
		  0.04663594046483888,
		  0.045081156540342844,
		  0.043202696044098106,
		  0.04099849429051236,
		  0.03847765220632961,
		  0.03567261111002296,
		  0.03263138429596518,
		  0.02939955656305224,
		  0.026037240524905556,
		  0.022633048320115097,
		  0.019232913695483172,
		  0.015921952170558078,
		  0.012747454980735425,
		  0.009757259216953088,
		  0.006978638220769068,
		  0.004424510860278145,
		  0.0020927206184564147,
		  -0.00002965122492762741,
		  -0.001964019021497103,
		  -0.0037350392557077795,
		  -0.005364534932887156,
		  -0.006868343925364158,
		  -0.008251693365657897,
		  -0.009507894412126666,
		  -0.010615025071490678,
		  -0.011540764119581194,
		  -0.012243449095484303,
		  -0.012679715855043539,
		  -0.012805102027720998,
		  -0.01258688756227853,
		  -0.012005605649957916,
		  -0.011058072804551034,
		  -0.009764459025167357,
		  -0.008166925139389873,
		  -0.006326046233047093,
		  -0.004321366216966219,
		  -0.0022437206001892037,
		  -0.00018472467841555655,
		  0.001762473344266541,
		  0.003521356088745773,
		  0.005030780924734345,
		  0.006254535098650449,
		  0.007181642699552285,
		  0.007829512594212608,
		  0.00823880431591013,
		  0.008469852998115944,
		  0.00859550617341363,
		  0.008693176253432402,
		  0.008835447947138357,
		  0.009081040701586014,
		  0.009469742018526527,
		  0.010014740164925935,
		  0.01070229545115118,
		  0.011487336422989965,
		  0.012306402673405385,
		  0.013067123635644093,
		  0.013676694282834221,
		  0.01403289456850413,
		  0.014043595517422841,
		  0.013638237562541927,
		  0.012767760394852088,
		  0.011414470022895255,
		  0.00959897179474267,
		  0.007374378209144512,
		  0.004823725659403927,
		  0.0020592583561588242,
		  -0.0007899639812546934,
		  -0.0035863761076325895,
		  -0.006195963524169574,
		  -0.008494358476285286,
		  -0.010378613194328402,
		  -0.011773343623041868,
		  -0.012636822452147345,
		  -0.012960285908648433,
		  -0.01276879757012133,
		  -0.012117629011990618,
		  -0.011086164938723301,
		  -0.009771145249317444,
		  -0.008276883743951472,
		  -0.006708082220353774,
		  -0.005162958310249838,
		  -0.0071208527855767855
		};
